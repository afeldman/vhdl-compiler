name: Build Compilers

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

jobs:
    build-brainfuck:
        name: Build Brainfuck Compiler
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Haskell
              uses: haskell-actions/setup@v2
              with:
                  ghc-version: "9.4.8"
                  enable-stack: true
                  stack-version: "latest"

            - name: Install LLVM
              run: |
                  sudo apt-get update
                  sudo apt-get install -y llvm-14 llvm-14-dev libllvm14 clang-14 || \
                  sudo apt-get install -y llvm-15 llvm-15-dev libllvm15 clang-15 || \
                  sudo apt-get install -y llvm llvm-dev clang

            - name: Install BNFC
              run: |
                  stack install BNFC
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Cache Stack dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.stack
                      bf/.stack-work
                  key: ${{ runner.os }}-stack-bf-${{ hashFiles('bf/stack.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-stack-bf-

            - name: Install Task
              run: |
                  sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

            - name: Build Brainfuck Compiler
              run: |
                  task build:bf

            - name: Test Brainfuck Compiler
              working-directory: bf
              run: |
                  stack exec bfc -- test/hello.bf -emit-llvm -o hello.ll
                  llc -filetype=obj hello.ll -o hello.o || llc-14 -filetype=obj hello.ll -o hello.o || llc-15 -filetype=obj hello.ll -o hello.o
                  clang hello.o -o hello || clang-14 hello.o -o hello || clang-15 hello.o -o hello
                  ./hello || true

            - name: Package Brainfuck Compiler
              run: |
                  mkdir -p artifacts/bf
                  cp -r bf/test artifacts/bf/
                  cp bf/README.md artifacts/bf/
                  cp bf/bf.cf artifacts/bf/
                  stack --work-dir bf/.stack-work install --local-bin-path artifacts/bf
                  tar -czf bf-compiler.tar.gz -C artifacts bf

            - name: Upload Brainfuck artifact
              uses: actions/upload-artifact@v4
              with:
                  name: bf-compiler
                  path: bf-compiler.tar.gz

    build-whitespace:
        name: Build Whitespace Compiler
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Haskell
              uses: haskell-actions/setup@v2
              with:
                  ghc-version: "9.4.8"
                  enable-stack: true
                  stack-version: "latest"

            - name: Install LLVM
              run: |
                  sudo apt-get update
                  sudo apt-get install -y llvm-14 llvm-14-dev libllvm14 clang-14 || \
                  sudo apt-get install -y llvm-15 llvm-15-dev libllvm15 clang-15 || \
                  sudo apt-get install -y llvm llvm-dev clang

            - name: Install BNFC
              run: |
                  stack install BNFC
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Cache Stack dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.stack
                      whitespace/.stack-work
                  key: ${{ runner.os }}-stack-ws-${{ hashFiles('whitespace/stack.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-stack-ws-

            - name: Build Whitespace Compiler
              run: |
                  task build:ws

            - name: Test Whitespace Compiler
              working-directory: whitespace
              run: |
                  stack exec wsc -- test/simple.ws -emit-llvm -o simple.ll
                  llc -filetype=obj simple.ll -o simple.o || llc-14 -filetype=obj simple.ll -o simple.o || llc-15 -filetype=obj simple.ll -o simple.o
                  clang simple.o -o simple || clang-14 simple.o -o simple || clang-15 simple.o -o simple
                  ./simple || true

            - name: Package Whitespace Compiler
              run: |
                  mkdir -p artifacts/whitespace
                  cp -r whitespace/test artifacts/whitespace/
                  cp whitespace/README.md artifacts/whitespace/
                  cp whitespace/whitespace.cf artifacts/whitespace/
                  stack --work-dir whitespace/.stack-work install --local-bin-path artifacts/whitespace
                  tar -czf ws-compiler.tar.gz -C artifacts whitespace

            - name: Upload Whitespace artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ws-compiler
                  path: ws-compiler.tar.gz

    build-grammars:
        name: Validate BNFC Grammars
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Haskell
              uses: haskell-actions/setup@v2
              with:
                  ghc-version: "9.4.8"
                  enable-stack: true
                  stack-version: "latest"

            - name: Install BNFC
              run: |
                  stack install BNFC
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Validate all grammars
              run: |
                  for dir in karel krl tpe urs vhdl bf json ini basic whitespace; do
                    echo "Validating $dir..."
                    cd $dir
                    if [ -f *.cf ]; then
                      bnfc -m --haskell *.cf || echo "Warning: $dir grammar validation failed"
                    fi
                    cd ..
                  done

            - name: Package grammars
              run: |
                  mkdir -p artifacts/grammars
                  for dir in karel krl tpe urs vhdl bf json ini basic whitespace; do
                    if [ -f $dir/*.cf ]; then
                      cp $dir/*.cf artifacts/grammars/
                    fi
                  done
                  tar -czf grammars.tar.gz -C artifacts grammars

            - name: Upload grammar artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: bnfc-grammars
                  path: grammars.tar.gz

    release:
        name: Create Release
        needs: [build-brainfuck, build-whitespace, build-grammars]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Get commit info
              id: commit
              run: |
                  echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: build-${{ steps.commit.outputs.date }}
                  name: Compiler Build ${{ steps.commit.outputs.date }}
                  body: |
                      ## ACC Compiler Collection

                      Automated build from commit ${{ github.sha }}

                      ### Available Compilers

                      - **Brainfuck Compiler** (`bf-compiler.tar.gz`)
                        - LLVM-based Brainfuck to native code compiler
                        - Executable: `bfc`
                        - Example: `bfc hello.bf -emit-llvm`

                      - **Whitespace Compiler** (`ws-compiler.tar.gz`)
                        - LLVM-based Whitespace to native code compiler
                        - Executable: `wsc`
                        - Example: `wsc program.ws -emit-llvm`

                      - **BNFC Grammars** (`grammars.tar.gz`)
                        - All validated BNFC grammar files
                        - Languages: Karel, KRL, TPE, URS, VHDL, Brainfuck, JSON, INI, BASIC, Whitespace

                      ### Installation

                      ```bash
                      # Extract compiler
                      tar -xzf bf-compiler.tar.gz
                      cd bf

                      # Run compiler
                      ./bfc test/hello.bf -emit-llvm
                      ```

                      ### Build Info
                      - Commit: ${{ github.sha }}
                      - Branch: ${{ github.ref_name }}
                      - Date: ${{ steps.commit.outputs.date }}
                  draft: false
                  prerelease: false
                  files: |
                      artifacts/bf-compiler/bf-compiler.tar.gz
                      artifacts/ws-compiler/ws-compiler.tar.gz
                      artifacts/bnfc-grammars/grammars.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
